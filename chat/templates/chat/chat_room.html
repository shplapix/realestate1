{% extends 'base.html' %}
{% load static %}
{% block title %}–ß–∞—Ç —Å {{ realtor_name }}{% endblock %}

{% block content %}
<div class="chat-layout">
    <!-- Chat Sidebar -->
    <div class="chat-sidebar">
        <div class="chat-sidebar-header">
            üí¨ –í—Å–µ —á–∞—Ç—ã
        </div>
        <div>
            {% for c in all_chats %}
            <div class="chat-list-item {% if c.id == chat.id %}active{% endif %}">
                <a href="{% url 'chat:room' c.id %}" style="text-decoration: none; color: inherit; display: block;">
                    <strong>
                        {% if user.realtor %}
                        {{ c.user.first_name }} {{ c.user.last_name }}
                        {% else %}
                        {{ c.realtor.name }}
                        {% endif %}
                    </strong>
                    {% if c.listing %}
                    <div style="font-size: 0.85rem; opacity: 0.8;">{{ c.listing.title|truncatewords:5 }}</div>
                    {% endif %}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
        <div class="chat-header">
            <h4 class="mb-0">{{ realtor_name }}</h4>
            <p class="mb-0" style="opacity: 0.9; font-size: 0.9rem;">{{ listing_title }}</p>
        </div>

        <div class="chat-messages" id="chat-messages-box">
            {% for message in chat_messages %}
            {% if user.realtor %}
            <!-- Realtor view -->
            {% if message.is_realtor_sender %}
            <!-- My message (right, blue) -->
            <div class="message message-sender">
                {{ message.content }}
                <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
            </div>
            {% else %}
            <!-- Buyer message (left, white) -->
            <div class="message message-receiver">
                <div class="message-sender-name">{{ chat.user.first_name }} {{ chat.user.last_name }}</div>
                {{ message.content }}
                <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
            </div>
            {% endif %}
            {% else %}
            <!-- Buyer view -->
            {% if message.is_realtor_sender %}
            <!-- Realtor message (left, white) -->
            <div class="message message-receiver">
                <div class="message-sender-name">{{ realtor_name }}</div>
                {{ message.content }}
                <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
            </div>
            {% else %}
            <!-- My message (right, blue) -->
            <div class="message message-sender">
                {{ message.content }}
                <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
            </div>
            {% endif %}
            {% endif %}
            {% endfor %}
        </div>

        <div class="chat-form">
            <form method="POST" action="{% url 'chat:send_message' chat.id %}" class="input-group">
                {% csrf_token %}
                <input type="text" name="content" class="form-control" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required
                    style="border-radius: 50px 0 0 50px;">
                <button class="btn btn-primary" type="submit" style="border-radius: 0 50px 50px 0;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<script>
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const messagesBox = document.getElementById('chat-messages-box');
    messagesBox.scrollTop = messagesBox.scrollHeight;
</script>
{% endblock %}