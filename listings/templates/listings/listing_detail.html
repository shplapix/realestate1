{% extends 'base.html' %}
{% block title %}{{ listing.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="text-gradient mb-3">{{ listing.title }}</h2>
                <p class="text-muted">üìç {{ listing.address }}, {{ listing.city }}, {{ listing.state }}</p>

                {% if listing.photo_main %}
                <img src="{{ listing.photo_main.url }}" class="img-fluid mb-3" alt="{{ listing.title }}"
                    style="width: 100%; max-height: 500px; object-fit: cover;">
                {% endif %}

                <div class="row mt-4">
                    {% if listing.photo_1 %}
                    <div class="col-md-6 mb-3">
                        <img src="{{ listing.photo_1.url }}" class="img-fluid" alt=""
                            style="width: 100%; height: 250px; object-fit: cover;">
                    </div>
                    {% endif %}
                    {% if listing.photo_2 %}
                    <div class="col-md-6 mb-3">
                        <img src="{{ listing.photo_2.url }}" class="img-fluid" alt=""
                            style="width: 100%; height: 250px; object-fit: cover;">
                    </div>
                    {% endif %}
                </div>

                <div class="mt-4">
                    <h5>üìù –û–ø–∏—Å</h5>
                    <p>{{ listing.description|linebreaks }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card mb-3">
            <div class="card-body text-center">
                {% if listing.realtor.photo %}
                <img src="{{ listing.realtor.photo.url }}" class="realtor-img-round mb-3"
                    alt="{{ listing.realtor.name }}">
                {% endif %}
                <h5 class="card-title">{{ listing.realtor.name }}</h5>
                <p class="card-text text-muted">üíº –†—ñ—î–ª—Ç–æ—Ä</p>
                <p class="card-text">üìû {{ listing.realtor.phone }}</p>
                <p class="card-text">üìß {{ listing.realtor.email }}</p>

                {% if user.is_authenticated %}
                <a href="{% url 'chat:start_chat' listing.realtor.id listing.id %}" class="btn btn-warning w-100 mt-3">
                    üí¨ –ü–æ—á–∞—Ç–∏ –ß–∞—Ç –∑ –†—ñ—î–ª—Ç–æ—Ä–æ–º
                </a>

                {% if not listing.is_sold %}
                <button type="button" class="btn btn-success w-100 mt-2" data-bs-toggle="modal"
                    data-bs-target="#paymentModal">
                    üí≥ –ö—É–ø–∏—Ç–∏
                </button>
                {% else %}
                <button class="btn btn-secondary w-100 mt-2" disabled>
                    ‚ùå –ü—Ä–æ–¥–∞–Ω–æ
                </button>
                {% endif %}

                {% else %}
                <p class="mt-3 text-danger">üîí –£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø–æ—á–∞—Ç–∏ —á–∞—Ç –∞–±–æ –∫—É–ø–∏—Ç–∏.</p>
                {% endif %}
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                üìä –î–µ—Ç–∞–ª—ñ –û–±'—î–∫—Ç–∞
            </div>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>üí∞ –¶—ñ–Ω–∞:</strong> ${{ listing.price|floatformat:0 }}</li>
                <li class="list-group-item"><strong>üõèÔ∏è –°–ø–∞–ª—å–Ω—ñ:</strong> {{ listing.bedrooms }}</li>
                <li class="list-group-item"><strong>üöø –í–∞–Ω–Ω—ñ:</strong> {{ listing.bathrooms }}</li>
                <li class="list-group-item"><strong>üöó –ì–∞—Ä–∞–∂:</strong> {{ listing.garage }}</li>
                <li class="list-group-item"><strong>üìê –ü–ª–æ—â–∞:</strong> {{ listing.sqft }} sqft</li>
                <li class="list-group-item"><strong>üå≥ –î—ñ–ª—è–Ω–∫–∞:</strong> {{ listing.lot_size }} acre</li>
            </ul>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">–û–ø–ª–∞—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm" action="{% url 'listings:purchase' listing.id %}" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="cardNumber" class="form-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="0000 0000 0000 0000">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiryDate" class="form-label">–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó</label>
                            <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cvv" placeholder="123">
                        </div>
                    </div>
                    <div id="paymentError" class="text-danger mb-3" style="display: none;"></div>
                    <div id="paymentSuccess" class="text-success mb-3" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button type="button" class="btn btn-primary" onclick="submitPayment()">–û–ø–ª–∞—Ç–∏—Ç–∏</button>
            </div>
        </div>
    </div>
</div>

<script>
    function submitPayment() {
        const cardNumber = document.getElementById('cardNumber').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const cvv = document.getElementById('cvv').value;
        const errorDiv = document.getElementById('paymentError');
        const successDiv = document.getElementById('paymentSuccess');
        const form = document.getElementById('paymentForm');

        // Simple validation: check if fields are not empty
        if (cardNumber.trim() === "" || expiryDate.trim() === "" || cvv.trim() === "") {
            errorDiv.innerText = "–û–ø–µ—Ä–∞—Ü—ñ—è –≤—ñ–¥—Ö–∏–ª–µ–Ω–∞";
            errorDiv.style.display = "block";
            successDiv.style.display = "none";
        } else {
            errorDiv.style.display = "none";
            successDiv.innerText = "–û–ø–µ—Ä–∞—Ü—ñ—è –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ";
            successDiv.style.display = "block";

            // Submit form after a short delay to show success message
            setTimeout(() => {
                form.submit();
            }, 1000);
        }
    }
</script>
{% endblock %}